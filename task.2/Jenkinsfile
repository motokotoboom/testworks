pipeline{
    agent any
    stages {
        stage('Get source') {
            steps {
                echo 'getting source'
                checkout scm

   
            }
        }
        stage('running php-apache'){
            steps{
                echo 'run php-apache docker image'           
                sh 'if ["`docker service ls --filter="name=task-2-apache" | wc -l`" != "2"]; then \
                    HOST=`/sbin/ip route|awk \'/default/ { print $3 }\'` docker service create --replicas=2 -p 80:80 --name task-2-apache --mount \'type=volume,src=www-root,volume-driver=local,dst=/var/www/html,volume-nocopy=true,volume-opt=type=nfs,volume-opt=device=:/var/www/html,volume-opt=o=addr=$HOST\' php:7.0-apache\
                else \
                    echo "Service is running aleady"; \
                fi'


            }
        }

    }
}

